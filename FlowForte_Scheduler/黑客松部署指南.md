# 🎯 FlowForte Scheduler 黑客松部署指南

## 📖 项目概述

### **我们开发了什么？**

**FlowForte Scheduler** 是一个创新的 DeFi 自动化调度系统，结合了 Flow 区块链的三大核心技术：

1. **Scheduled Transactions（定时交易）** - Flow 独有的自动执行功能
2. **Flow Actions（链上操作组合）** - 组合多个 DeFi 操作
3. **跨 VM 调用** - Cadence 合约调用 EVM 合约

### **解决什么问题？**

传统 DeFi 自动化需要：
- ❌ 用户在线手动执行
- ❌ 依赖中心化 Bot 服务
- ❌ 复杂的链下基础设施

我们的方案：
- ✅ **完全去中心化** - 无需任何中心化服务器
- ✅ **自动执行** - 定时自动触发，用户无需在线
- ✅ **跨 VM 能力** - Cadence 调度器 + EVM PersonalVault

### **技术架构**

```
用户设置定时任务
    ↓
FlowForte Scheduler (Cadence 合约)
    ↓
Scheduled Transaction (定时触发)
    ↓
Flow Actions (价格查询 + 计算)
    ↓
跨 VM 调用 EVM PersonalVault
    ↓
PunchSwap V2 执行交易
```

### **核心功能**

1. **定时定额投资（DCA）**
   - 每天 10:00 自动用 50 FLOW 购买 USDC
   - 每周一自动执行投资策略
   - 自定义时间间隔

2. **智能交易调度**
   - 一次性定时交易
   - 循环定时交易（每小时/每天/每周）
   - 灵活的时间配置

3. **安全保护**
   - 滑点保护
   - 权限控制（ORACLE_ROLE）
   - 价格异常检测

---

## 🏗️ 项目结构

### **已完成的部分**

#### 1. **PersonalVault (EVM 合约)** ✅
- **位置**: `/PersonalVault_Flow-EVM/`
- **状态**: 已部署到 Flow EVM 主网
- **地址**: 
  - Factory: `0x486eDaD5bBbDC8eD5518172b48866cE747899D89`
  - Implementation: `0x2E3b9Bb10a643DaDEDe356049e0bfdF0B6aDcd8a`
- **功能**: 
  - 用户资产管理
  - 代币存取
  - 通过 PunchSwap V2 执行交易

#### 2. **FlowForte Scheduler (Cadence 合约)** 🚧
- **位置**: `/FlowForte_Scheduler/`
- **状态**: 待部署到主网
- **核心文件**:
  - `cadence/contracts/TradingScheduler.cdc` - 调度器合约
  - `api/scheduler-service.js` - JavaScript API
  - `examples/` - 使用示例

---

## 🚀 最简部署步骤（5步完成）

### **前提条件检查**

你已经有：
- ✅ Flow 主网账户（已注册 Flow Wallet）
- ✅ 10 FLOW 代币（用于部署和测试）
- ✅ PersonalVault 已部署（EVM 侧）

### **步骤 1: 配置环境变量**

创建 `.env.mainnet` 文件：

```bash
cd /Users/beastgirl/Desktop/flow-forte-contract/FlowForte_Scheduler
cp .env.mainnet.example .env.mainnet
```

编辑 `.env.mainnet`，填入你的信息：

```env
# ========================================
# Flow 主网账户配置
# ========================================
FLOW_MAINNET_ADDRESS=0x你的Flow地址
FLOW_MAINNET_PRIVATE_KEY=你的私钥

# ========================================
# 合约地址（部署后填写）
# ========================================
TRADING_SCHEDULER_ADDRESS=

# ========================================
# EVM Vault 配置
# ========================================
VAULT_ADDRESS=0x你的PersonalVault地址

# 已部署的合约（无需修改）
FACTORY_ADDRESS=0x486eDaD5bBbDC8eD5518172b48866cE747899D89
WFLOW_ADDRESS=0xd3bF53DAC106A0290B0483EcBC89d40FcC961f3e
SWAP_ROUTER=0xf45AFe28fd5519d5f8C1d4787a4D5f724C0eFa4d
```

### **步骤 2: 检查账户余额**

```bash
flow accounts get 0x你的地址 --network mainnet
```

确保显示余额 ≥ 10 FLOW

### **步骤 3: 部署 Cadence 合约**

```bash
cd /Users/beastgirl/Desktop/flow-forte-contract/FlowForte_Scheduler
flow project deploy --network mainnet
```

**预期输出**：
```
Deploying 2 contracts for accounts: mainnet-account

TradingScheduler -> 0x你的地址
ScheduledSwapHandler -> 0x你的地址

✅ All contracts deployed successfully
```

**重要**: 记录你的账户地址，这就是合约地址！

### **步骤 4: 更新环境变量**

编辑 `.env.mainnet`，填写合约地址：

```env
TRADING_SCHEDULER_ADDRESS=0x你的地址
```

### **步骤 5: 安装依赖并测试**

```bash
# 安装 Node.js 依赖
npm install

# 运行主网测试
npm run test:mainnet
```

**测试流程**：
1. 脚本会警告这是主网操作
2. 等待 5 秒（可按 Ctrl+C 取消）
3. 创建一个 5 分钟后执行的测试任务
4. 输出 FlowScan 链接

---

## 🧪 测试步骤

### **测试 1: 创建定时任务**

运行测试脚本：
```bash
npm run test:mainnet
```

**应该看到**：
```
========================================
FlowForte Scheduler - Mainnet Test
========================================

⚠️  WARNING: This will use REAL FLOW on MAINNET!
Press Ctrl+C to cancel, or wait 5 seconds to continue...

📋 Task Configuration:
Execute At: 2025-10-27T07:03:00.000Z
Vault Address: 0x你的Vault地址
Amount: 0.1 FLOW (small test)

📤 Submitting to MAINNET...

✅ Transaction submitted!
Transaction ID: abc123...

🔗 View on FlowScan MAINNET:
https://flowscan.io/transaction/abc123...

⏳ Waiting for seal...

✅ Transaction sealed!

📊 Events:
  - TradingScheduler.TaskScheduled
```

### **测试 2: 在 FlowScan 查看**

访问输出的链接：`https://flowscan.io/transaction/{txId}`

**应该看到**：
1. ✅ Transaction Status: **Sealed**
2. ✅ Events: `TradingScheduler.TaskScheduled`
3. ✅ Event Data:
   - `taskId`: 1
   - `vaultAddress`: 你的 Vault 地址
   - `tokenIn`: FLOW
   - `tokenOut`: WFLOW
   - `amountIn`: 100000000000000000 (0.1 FLOW)
   - `executeAt`: 时间戳
   - `recurring`: false

### **测试 3: 查询任务状态（可选）**

创建查询脚本 `query-task.js`：

```javascript
const fcl = require("@onflow/fcl");
require("dotenv").config({ path: ".env.mainnet" });

fcl.config({
    "accessNode.api": "https://rest-mainnet.onflow.org",
    "0xTradingScheduler": process.env.TRADING_SCHEDULER_ADDRESS,
});

async function queryTask() {
    const script = `
        import TradingScheduler from ${process.env.TRADING_SCHEDULER_ADDRESS}
        
        access(all) fun main(taskId: UInt64): TradingScheduler.TaskInfo? {
            return TradingScheduler.getTaskInfo(taskId: taskId)
        }
    `;
    
    const result = await fcl.query({
        cadence: script,
        args: (arg, t) => [arg("1", t.UInt64)]
    });
    
    console.log("Task Info:", result);
}

queryTask();
```

运行：
```bash
node query-task.js
```

---

## 📊 黑客松演示要点

### **1. 技术创新点**

#### **Scheduled Transactions（核心亮点）**
```cadence
// 定时自动执行，无需外部触发
access(FlowTransactionScheduler.Execute) 
fun executeTransaction(id: UInt64, data: AnyStruct?) {
    // 到达指定时间后，Flow 区块链自动执行
    let taskId = data as! UInt64
    self.executeSwap(taskId: taskId)
}
```

**优势**：
- 完全去中心化
- 无需 Bot 服务器
- 无需用户在线
- Gas 费由调度器支付

#### **Flow Actions 集成**
```cadence
// 生成唯一 ID 用于追踪
let uniqueId = DeFiActions.generateUniqueId()

// 查询价格（示例）
let price = oracle.getPrice(uniqueId: uniqueId)
```

**优势**：
- 链上价格查询
- 事件关联追踪
- 组合多个操作

#### **跨 VM 调用**
```cadence
// Cadence 调用 EVM 合约
let result = EVM.run(
    to: evmAddress,
    data: callData,
    gasLimit: 1000000,
    value: value
)
```

**优势**：
- Cadence 的调度能力
- EVM 的生态兼容性
- 最佳的两个世界

### **2. 实际应用场景**

#### **场景 A: 定期定额投资（DCA）**
```javascript
// 每天 10:00 自动用 50 FLOW 购买 USDC
{
  "schedule": {
    "frequency": "daily",
    "time": "10:00 UTC"
  },
  "action": {
    "tokenIn": "FLOW",
    "tokenOut": "USDC",
    "amountIn": 50,
    "slippage": 0.01
  }
}
```

#### **场景 B: 自动再平衡**
```javascript
// 每周一检查并再平衡投资组合
{
  "schedule": {
    "frequency": "weekly",
    "dayOfWeek": "Monday",
    "time": "00:00 UTC"
  },
  "action": {
    "type": "rebalance",
    "targetRatio": {"FLOW": 0.5, "USDC": 0.5}
  }
}
```

### **3. 演示流程**

**Step 1**: 展示 FlowScan 上的合约
- 访问: `https://flowscan.io/address/0x你的地址`
- 展示已部署的 TradingScheduler 合约

**Step 2**: 创建定时任务
- 运行: `npm run test:mainnet`
- 展示控制台输出

**Step 3**: 查看区块链记录
- 打开 FlowScan 链接
- 展示 TaskScheduled 事件
- 解释事件参数

**Step 4**: 等待执行（如果时间允许）
- 5 分钟后任务自动执行
- 展示 TaskExecuted 事件
- 展示 EVM 侧的交易记录

---

## 🎯 黑客松评审要点

### **技术实现**

1. ✅ **Scheduled Transactions 集成**
   - 使用 Flow 原生的定时交易功能
   - 完全去中心化的自动执行

2. ✅ **Flow Actions 应用**
   - UniqueID 生成和追踪
   - 事件关联

3. ✅ **跨 VM 调用**
   - Cadence 调度器调用 EVM PersonalVault
   - 完整的 ABI 编码实现

4. ✅ **实际可用性**
   - 已部署到主网
   - 可以实际运行和测试
   - 有完整的文档和示例

### **创新性**

1. **首个结合 Scheduled Transactions 的 DeFi 应用**
   - 充分利用 Flow 独特功能
   - 解决实际用户需求

2. **跨 VM 协作**
   - Cadence 的调度能力
   - EVM 的生态兼容性

3. **完全去中心化**
   - 无需任何中心化服务
   - 无需用户在线

### **实用价值**

1. **真实需求**
   - DCA 投资策略
   - 自动化交易
   - 降低用户操作门槛

2. **可扩展性**
   - 支持多种调度策略
   - 可集成更多 DeFi 协议
   - 可添加更复杂的条件

---

## 📝 部署检查清单

### **部署前**
- [ ] Flow 主网账户准备好
- [ ] 账户有 ≥ 10 FLOW
- [ ] `.env.mainnet` 配置完成
- [ ] PersonalVault 地址确认

### **部署中**
- [ ] `flow project deploy --network mainnet` 成功
- [ ] 记录合约地址
- [ ] 更新 `.env.mainnet`

### **部署后**
- [ ] `npm install` 完成
- [ ] `npm run test:mainnet` 成功
- [ ] FlowScan 可以看到交易
- [ ] TaskScheduled 事件正确触发

### **演示准备**
- [ ] 准备好 FlowScan 链接
- [ ] 准备好代码演示
- [ ] 准备好架构图
- [ ] 准备好应用场景说明

---

## 🆘 常见问题

### **Q1: 如果没有 PersonalVault 地址怎么办？**

**方案 A**: 创建新的 Vault
```bash
cd /Users/beastgirl/Desktop/flow-forte-contract/PersonalVault_Flow-EVM
npx hardhat run scripts/createVault.js --network flow
```

**方案 B**: 使用测试地址（仅演示）
```env
VAULT_ADDRESS=0x0000000000000000000000000000000000000000
```

### **Q2: 部署失败怎么办？**

**检查**：
1. 账户余额是否充足
2. `.env.mainnet` 配置是否正确
3. `flow.json` 中的地址和私钥是否匹配

**调试**：
```bash
flow project deploy --network mainnet --log-level debug
```

### **Q3: 如何验证任务会自动执行？**

**方法 1**: 设置短时间间隔（5分钟）
```javascript
const executeAt = Math.floor(Date.now() / 1000) + 300; // 5分钟后
```

**方法 2**: 查看 FlowScan 事件
- TaskScheduled: 任务已创建
- TaskExecuted: 任务已执行（需要等待）

### **Q4: 如何展示跨 VM 调用？**

**展示点**：
1. **Cadence 侧**: FlowScan 上的 TradingScheduler 交易
2. **EVM 侧**: EVM FlowScan 上的 PersonalVault 交易
3. **关联**: 通过 UniqueID 或时间戳关联两笔交易

---

## 🎉 成功标准

### **最小可行演示（MVP）**

1. ✅ Cadence 合约成功部署到主网
2. ✅ 可以创建定时任务
3. ✅ FlowScan 可以看到 TaskScheduled 事件
4. ✅ 代码可以运行和演示

### **完整演示**

1. ✅ 所有 MVP 要求
2. ✅ 任务自动执行（等待 5 分钟）
3. ✅ FlowScan 可以看到 TaskExecuted 事件
4. ✅ EVM 侧可以看到实际的 swap 交易
5. ✅ 完整的端到端流程演示

---

## 📞 需要帮助？

如果遇到问题：

1. **查看日志**
   - FlowScan: `https://flowscan.io/`
   - 控制台输出
   - Flow CLI 日志

2. **检查配置**
   - `.env.mainnet` 文件
   - `flow.json` 文件
   - 账户余额

3. **调试步骤**
   - 逐步执行每个命令
   - 记录错误信息
   - 查看官方文档

---

## 🚀 准备好了！

现在你已经了解：
- ✅ 项目的核心价值和创新点
- ✅ 完整的部署流程
- ✅ 测试和验证方法
- ✅ 黑客松演示要点

**下一步**：
1. 按照"最简部署步骤"完成部署
2. 运行测试验证功能
3. 准备演示材料
4. 展示你的创新！

**祝黑客松顺利！** 🎉
